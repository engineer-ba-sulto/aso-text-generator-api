### チケット: P3-004 概要 (4,000 文字) 生成

#### 背景 / 目的

- **背景**: サブタイトル生成が完了し、概要生成の具体的なロジック実装が必要
- **目的**: 主要キーワードを4〜7回程度自然に含めつつ、アプリの特徴を説明する4,000文字以内の概要をGemini APIで生成する機能を実装する

#### スコープ（このチケットでやること）

1. **概要生成サービスクラスの実装**
   - `description_generator.py`の完全実装
   - Gemini APIとの連携機能
   - 言語別プロンプトの適用

2. **主要キーワード組み込みロジック**
   - 主要キーワードを4〜7回自然に含める仕組み
   - キーワード密度の最適化
   - 自然な文章構造の維持

3. **4,000文字制限の管理**
   - 文字数チェック機能
   - 自動調整機能
   - 制限超過時の処理

4. **アプリ特徴説明機能**
   - アプリの価値提案の明確化
   - ユーザーベネフィットの強調
   - 機能説明の構造化

5. **品質保証機能**
   - 生成テキストの品質チェック
   - キーワード密度の検証
   - 一貫性の確保

#### やらないこと（Out of Scope）

- APIエンドポイントの統合（ステップ4で対応）
- データベースへの保存機能
- ユーザーインターフェース
- 画像生成機能

#### 受入条件（Acceptance Criteria）

- 概要が4,000文字以内で生成されること
- 主要キーワードが4〜7回自然に含まれていること
- 日本語・英語の両方で適切に生成されること
- アプリの特徴を適切に説明していること
- ユーザーベネフィットが明確に表現されていること
- 文章の構造が論理的で読みやすいこと
- エラーハンドリングが適切に動作すること
- 単体テストが実装され、カバレッジが85%以上であること

#### 技術仕様

**クラス構造:**
```python
class DescriptionGenerator:
    def __init__(self, gemini_generator: GeminiGenerator)
    def generate_description(self, app_info: dict, main_keyword: str, language: str = "ja") -> str
    def _validate_description(self, description: str, main_keyword: str) -> bool
    def _check_keyword_density(self, text: str, keyword: str) -> int
    def _adjust_length(self, description: str, max_length: int = 4000) -> str
    def _optimize_keyword_placement(self, text: str, keyword: str) -> str
```

**入力パラメータ:**
- `app_info`: アプリ情報（名前、特徴、ターゲットユーザー、機能など）
- `main_keyword`: 主要キーワード（4〜7回含める対象）
- `language`: 生成言語（"ja" or "en"）

**出力仕様:**
- 4,000文字以内の文字列
- 主要キーワードを4〜7回自然に含む
- アプリの特徴を説明
- ユーザーベネフィットを強調
- 論理的な文章構造

#### 影響/変更ファイル

- 追加:
  - `app/services/description_generator.py` (概要生成サービス)
  - `tests/test_description_generator.py` (概要生成テスト)
- 変更:
  - `app/services/text_generator.py` (概要生成機能の統合)

#### 依存関係 / ブロッカー

- **依存**: P3-001（Gemini サービスクラスの実装）、P3-002（多言語プロンプト管理）、P3-003（サブタイトル生成）の完了
- **後続**: ステップ4（APIエンドポイントの統合）は本チケットの完了に依存

#### 実装手順

1. **概要生成サービスクラス実装**
   - `DescriptionGenerator`クラスの基本構造
   - Gemini APIとの連携
   - 言語別プロンプトの適用

2. **主要キーワード組み込みロジック実装**
   - キーワード密度チェック機能
   - 自然な組み込み機能
   - 最適化機能

3. **文字数制限管理実装**
   - 4,000文字制限の厳格なチェック
   - 自動調整機能
   - 制限超過時の処理

4. **アプリ特徴説明機能実装**
   - 価値提案の明確化
   - ユーザーベネフィットの強調
   - 機能説明の構造化

5. **品質保証機能実装**
   - 生成テキストの品質チェック
   - キーワード密度の検証
   - 一貫性の確保

6. **エラーハンドリング実装**
   - API呼び出しエラーの処理
   - バリデーションエラーの処理
   - フォールバック機能

7. **テスト実装**
   - 単体テストの作成
   - モックを使用したテスト
   - エラーケースのテスト

#### 概要生成アルゴリズム

1. **プロンプト準備**
   - 言語別プロンプトの選択
   - アプリ情報のプロンプトへの組み込み
   - 主要キーワード組み込みの明示

2. **Gemini API呼び出し**
   - プロンプトの送信
   - レスポンスの取得
   - エラーハンドリング

3. **後処理**
   - 主要キーワードの密度確認
   - 文字数制限の確認
   - 品質チェック

4. **調整処理**
   - 制限超過時の自動調整
   - キーワード密度不足時の再生成
   - 品質不足時の改善

#### キーワード密度管理

**目標密度:**
- 主要キーワード: 4〜7回
- 密度計算: (キーワード出現回数 / 総文字数) × 1000
- 最適密度: 1.0〜1.75（4,000文字中4〜7回）

**組み込み戦略:**
- 導入部: 1回（アプリの概要説明）
- 本文: 3〜5回（機能説明、ベネフィット説明）
- 結論部: 1回（まとめ、行動喚起）

#### 品質チェック項目

- **文字数**: 4,000文字以内
- **キーワード密度**: 主要キーワードが4〜7回含まれている
- **自然性**: キーワードが自然に組み込まれている
- **価値表現**: アプリの価値を適切に表現
- **構造**: 論理的な文章構造
- **読みやすさ**: 読みやすく理解しやすい文章
- **適切性**: 不適切なコンテンツが含まれていない
- **一貫性**: アプリの特徴と一貫している

#### 参考資料

- [App Store 説明文ガイドライン](https://developer.apple.com/app-store/description-guidelines/)
- [Google Play 詳細説明ガイドライン](https://support.google.com/googleplay/android-developer/answer/9859452)
- [Gemini Pro プロンプトエンジニアリング](https://ai.google.dev/docs/prompt_engineering)
- [SEO キーワード密度ガイド](https://developers.google.com/search/docs/advanced/guidelines/quality-guidelines)

#### リスク / 留意点

- **文字数制限**: 4,000文字という長文での制限管理
- **キーワード密度**: 自然な組み込みと適切な密度のバランス
- **品質保証**: 長文での品質と一貫性の確保
- **言語特性**: 日本語・英語の言語特性の違い
- **API制限**: Gemini APIの利用制限への対応
- **処理時間**: 長文生成による処理時間の増加

#### 見積り

- **3時間**
  - 概要生成サービスクラス実装: 1時間
  - 主要キーワード組み込みロジック実装: 45分
  - 文字数制限管理実装: 30分
  - アプリ特徴説明機能実装: 30分
  - テスト実装: 15分

#### 完了定義

- [ ] 概要生成サービスが実装されている
- [ ] 4,000文字制限が厳格に管理されている
- [ ] 主要キーワードが4〜7回自然に含まれている
- [ ] 日本語・英語の両方で適切に生成される
- [ ] アプリの特徴が適切に説明されている
- [ ] 品質保証機能が動作している
- [ ] 単体テストが実装され、カバレッジが85%以上である
- [ ] エラーハンドリングが適切に動作している
