### チケット: P3-003 サブタイトル (30 文字) 生成

#### 背景 / 目的

- **背景**: Gemini API連携と多言語プロンプト管理が完了し、サブタイトル生成の具体的なロジック実装が必要
- **目的**: 主要キーワードを含めずにアプリの価値を表現する、30文字以内のサブタイトルをGemini APIで生成する機能を実装する

#### スコープ（このチケットでやること）

1. **サブタイトル生成サービスクラスの実装**
   - `subtitle_generator.py`の完全実装
   - Gemini APIとの連携機能
   - 言語別プロンプトの適用

2. **主要キーワード除外ロジック**
   - 主要キーワードを明示的に除外する仕組み
   - キーワード検出とフィルタリング機能
   - 代替表現の提案機能

3. **30文字制限の厳格な管理**
   - 文字数チェック機能
   - 自動調整機能
   - 制限超過時の処理

4. **品質保証機能**
   - 生成テキストの品質チェック
   - 不適切なコンテンツのフィルタリング
   - 一貫性の確保

#### やらないこと（Out of Scope）

- 概要生成の実装（P3-004で対応）
- APIエンドポイントの統合（ステップ4で対応）
- データベースへの保存機能
- ユーザーインターフェース

#### 受入条件（Acceptance Criteria）

- サブタイトルが30文字以内で生成されること
- 主要キーワードが含まれていないこと
- 日本語・英語の両方で適切に生成されること
- アプリの価値を適切に表現していること
- 魅力的で覚えやすいサブタイトルが生成されること
- エラーハンドリングが適切に動作すること
- 単体テストが実装され、カバレッジが85%以上であること

#### 技術仕様

**クラス構造:**
```python
class SubtitleGenerator:
    def __init__(self, gemini_generator: GeminiGenerator)
    def generate_subtitle(self, app_info: dict, main_keyword: str, language: str = "ja") -> str
    def _validate_subtitle(self, subtitle: str, main_keyword: str) -> bool
    def _adjust_length(self, subtitle: str, max_length: int = 30) -> str
    def _filter_keywords(self, text: str, keywords: List[str]) -> str
```

**入力パラメータ:**
- `app_info`: アプリ情報（名前、特徴、ターゲットユーザーなど）
- `main_keyword`: 主要キーワード（除外対象）
- `language`: 生成言語（"ja" or "en"）

**出力仕様:**
- 30文字以内の文字列
- 主要キーワードを含まない
- アプリの価値を表現
- 魅力的で覚えやすい

#### 影響/変更ファイル

- 追加:
  - `app/services/subtitle_generator.py` (サブタイトル生成サービス)
  - `tests/test_subtitle_generator.py` (サブタイトル生成テスト)
- 変更:
  - `app/services/text_generator.py` (サブタイトル生成機能の統合)

#### 依存関係 / ブロッカー

- **依存**: P3-001（Gemini サービスクラスの実装）、P3-002（多言語プロンプト管理）の完了
- **後続**: P3-004（概要生成）は本チケットの完了に依存

#### 実装手順

1. **サブタイトル生成サービスクラス実装**
   - `SubtitleGenerator`クラスの基本構造
   - Gemini APIとの連携
   - 言語別プロンプトの適用

2. **主要キーワード除外ロジック実装**
   - キーワード検出機能
   - フィルタリング機能
   - 代替表現生成機能

3. **文字数制限管理実装**
   - 30文字制限の厳格なチェック
   - 自動調整機能
   - 制限超過時の処理

4. **品質保証機能実装**
   - 生成テキストの品質チェック
   - 不適切なコンテンツのフィルタリング
   - 一貫性の確保

5. **エラーハンドリング実装**
   - API呼び出しエラーの処理
   - バリデーションエラーの処理
   - フォールバック機能

6. **テスト実装**
   - 単体テストの作成
   - モックを使用したテスト
   - エラーケースのテスト

#### サブタイトル生成アルゴリズム

1. **プロンプト準備**
   - 言語別プロンプトの選択
   - アプリ情報のプロンプトへの組み込み
   - 主要キーワード除外の明示

2. **Gemini API呼び出し**
   - プロンプトの送信
   - レスポンスの取得
   - エラーハンドリング

3. **後処理**
   - 主要キーワードの除外確認
   - 文字数制限の確認
   - 品質チェック

4. **調整処理**
   - 制限超過時の自動調整
   - キーワード検出時の再生成
   - 品質不足時の改善

#### 品質チェック項目

- **文字数**: 30文字以内
- **キーワード除外**: 主要キーワードが含まれていない
- **価値表現**: アプリの価値を適切に表現
- **魅力**: 魅力的で覚えやすい表現
- **適切性**: 不適切なコンテンツが含まれていない
- **一貫性**: アプリの特徴と一貫している

#### 参考資料

- [App Store サブタイトルガイドライン](https://developer.apple.com/app-store/subtitle-guidelines/)
- [Google Play ショート説明ガイドライン](https://support.google.com/googleplay/android-developer/answer/9859452)
- [Gemini Pro プロンプトエンジニアリング](https://ai.google.dev/docs/prompt_engineering)

#### リスク / 留意点

- **文字数制限**: 30文字という厳しい制限への対応
- **キーワード除外**: 主要キーワードの確実な除外
- **品質保証**: 生成テキストの品質と一貫性
- **言語特性**: 日本語・英語の言語特性の違い
- **API制限**: Gemini APIの利用制限への対応

#### 見積り

- **3時間**
  - サブタイトル生成サービスクラス実装: 1時間
  - 主要キーワード除外ロジック実装: 45分
  - 文字数制限管理実装: 30分
  - 品質保証機能実装: 30分
  - テスト実装: 15分

#### 完了定義

- [ ] サブタイトル生成サービスが実装されている
- [ ] 30文字制限が厳格に管理されている
- [ ] 主要キーワードが確実に除外されている
- [ ] 日本語・英語の両方で適切に生成される
- [ ] 品質保証機能が動作している
- [ ] 単体テストが実装され、カバレッジが85%以上である
- [ ] エラーハンドリングが適切に動作している
